"""
Class that attaches to the Twitter Streaming API
"""
__author__ = 'Derek Ruths (druths@networkdynamics.org)'

import pycurl, json, sys

FILTER_URL = "https://stream.twitter.com/1/statuses/filter.json"
SAMPLE_URL = "https://stream.twitter.com/1/statuses/sample.json"

USER = None # should be a string
PASS = None # should be a string

TIMEOUT = 60*60*3

class TwitterStreamSampler:

	def __init__(self,username,password):
		"""
		Args
		----
			- ``username`` is a string containing the username of the authenticating account
			- ``password`` is a string containing the password of the authenticating account
		"""
		self.username = username
		self.password = password

	def start(self):
		self.buffer = ""
		self.conn = pycurl.Curl()
		self.conn.setopt(pycurl.USERPWD, "%s:%s" % (self.username, self.password))
		self.conn.setopt(pycurl.URL, SAMPLE_URL)
		self.conn.setopt(pycurl.POST, False) # The sample stream uses GET, not POST
		self.conn.setopt(pycurl.WRITEFUNCTION, self.on_receive)
		self.conn.setopt(pycurl.TIMEOUT, TIMEOUT)
		
		self.conn.perform()

	def on_receive(self, data):
		self.buffer += data
		if data.endswith("\r\n") and self.buffer.strip():
			tweet = self.buffer
			try:
				content = json.loads(self.buffer)			 
				self.buffer = ""
				print tweet.replace('\n','')
			except Exception, e:
				print e
				sys.exit(1)

class TwitterStreamFilter:

	def __init__(self,username,password,track_string):
		"""
		Args
		----
			- ``username`` is a string containing the username of the authenticating account
			- ``password`` is a string containing the password of the authenticating account
			- ``track_terms`` is a non-zero length list of lists of strings.  Each list of strings
			  specifies a set of terms that must all be found together (an AND operation). Each
			  list of strings is ORed together such that only one of the list of strings must be
			  satisfied for a tweet to pass the filter.
			
		For example, the constructor::
			
			TwitterStreamFilter('user','pass',[['happy 16th birthday'],['happy 18th birthday'],['happy 21st birthday']])
			
		creates a filter that will recognize happy birthday wishes for people turning 16, 18, and 21.
		"""
		self.username = username
		self.password = password
		self.track_terms = track_terms

	def start(self):
		self.buffer = ""
		self.conn = pycurl.Curl()
		self.conn.setopt(pycurl.USERPWD, "%s:%s" % (self.username, self.password))
		self.conn.setopt(pycurl.URL, FILTER_URL)
		self.conn.setopt(pycurl.POST, True)
		self.conn.setopt(pycurl.WRITEFUNCTION, self.on_receive)
		self.conn.setopt(pycurl.TIMEOUT, TIMEOUT)
		
		track_string = ','.join([' '.join(x) for x in self.track_terms])
		self.conn.setopt(pycurl.POSTFIELDS, 'track=' + track_string)
		self.conn.perform()

	def on_receive(self, data):
		self.buffer += data
		if data.endswith("\r\n") and self.buffer.strip():
			tweet = self.buffer
			try:
				content = json.loads(self.buffer)			 
				self.buffer = ""
				print tweet.replace('\n','')
			except Exception, e:
				print e
				sys.exit(1)

if __name__ == '__main__':
	import getpass
	
	operation = sys.argv[1]
	
	if operation == 'sample':
		uname = sys.argv[2]
		passwd = getpass.getpass('Enter password:')
		ss = TwitterStreamSampler(uname,passwd)
		ss.start()
	elif operation == 'filter':
		uname = sys.argv[2]
		passwd = getpass.getpass('Enter password:')
	
		track_ands = sys.argv[3:]
		track_terms = [x.split() for x in track_ands]
		fs = TwitterStreamFilter(uname,passwd,track_terms)
		fs.start()